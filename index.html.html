// Substitua a sua função handleAnalysis antiga por esta:
async function handleAnalysis() {
    analysisResults.classList.add('hidden');
    errorMessage.classList.add('hidden');
    loadingSpinner.classList.remove('hidden');
    analyzeBtn.disabled = true;

    try {
        const manualTranscript = transcriptInput.value.trim();
        const ccName = ccNameInput.value.trim();
        const readPromises = uploadedFiles.map(file => file.text());
        const fileTranscripts = await Promise.all(readPromises);
        const combinedTranscript = [manualTranscript, ...fileTranscripts].filter(Boolean).join('\n\n---\n\n');
        const analysisType = document.querySelector('input[name="analysis-type"]:checked').value;

        // Chamada para a sua API na Vercel
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                transcript: combinedTranscript,
                ccName: ccName,
                analysisType: analysisType
            })
        });

        if (!response.ok) throw new Error("Erro na comunicação com o servidor.");

        const analysisData = await response.json();
        displayResults(analysisData, analysisType);

    } catch (error) {
        console.error("Erro:", error);
        loadingSpinner.classList.add('hidden');
        errorMessage.textContent = error.message;
        errorMessage.classList.remove('hidden');
    } finally {
        analyzeBtn.disabled = false;
    }
}
